# Bringing VPS configuration under Infrastructure as Code

## Context

- Homelab managed with OpenTofu, currently mainly for DNS configuration.
- A remote VPS on Hetzner runs Pangolin for authentication/authorization and tunneling to homelab services, providing isolation between internet-facing services and the homelab.
- Pangolin is Docker-based, installed manually via its own installer.
- The VPS is currently entirely manually configured.

## Goal

Make the VPS configuration declarative and reproducible. The VPS should be treated as disposable - easily rebuilt from config. Data on the VPS needs a pull-based backup to the homelab (TrueNAS).

## Options considered

### Ansible

- Works with existing Linux distro, no OS change needed.
- Pairs with OpenTofu (Tofu provisions, Ansible configures).
- Incremental adoption possible.
- **Concern:** push-based and prone to config drift. Ansible describes desired state but doesn't prevent out-of-band changes. If the goal is a truly reproducible, disposable VPS, Ansible is a halfway measure.

### OpenTofu + cloud-init + Docker Compose

- Minimal new tooling, leverages existing OpenTofu knowledge.
- Truly disposable on reprovision.
- **Concern:** only handles initial setup; ongoing changes require reprovisioning or manual SSH. Limited flexibility for non-Docker system config.

### NixOS (chosen direction)

- The entire OS is derived from config - no drift by design.
- Strongest guarantee of reproducibility; if it's not in the config, it's not on the system.
- Best philosophical fit for "disposable, reproducible VPS."
- Pangolin runs in Docker, so NixOS just needs to declare Docker and a Compose setup - no need for a native Nix package.
- **Trade-off:** steep learning curve, but worth the investment.

## Plan

1. **Learn NixOS** on a local VM or throwaway VPS first - get comfortable declaring Docker services and system config before touching production.
2. **Repo structure:** Keep OpenTofu (Hetzner provisioning) and NixOS config in the same repo, since they're tightly coupled.
3. **Provisioning workflow:** OpenTofu provisions the Hetzner VPS, then nixos-anywhere installs the declared NixOS config over SSH.
4. **Migration:** Back up Pangolin data, provision new NixOS VPS, declare Pangolin's Docker setup in NixOS config, restore data, cut over DNS.
5. **Backups:** Pull-based from TrueNAS (e.g., Restic or Borg over SSH) on a schedule, targeting the Pangolin data directory.

## Open questions

- Specific NixOS module structure for declaring Docker Compose services.
- How nixos-anywhere integrates with the Hetzner OpenTofu provider.
- Backup tooling selection (Restic vs Borg vs other).
- Whether to manage TrueNAS backup jobs as code as well.
